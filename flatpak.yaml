app-id: org.openmediastation.open_media_server_app
runtime: org.gnome.Platform
runtime-version: '47'
sdk: org.gnome.Sdk
command: open_media_server_app
finish-args:
- --socket=fallback-x11
- --socket=wayland
- --socket=pulseaudio #This might be needed
- --share=network
- --share=ipc
- --device=dri
- --filesystem=xdg-download
- --talk-name=org.freedesktop.Notifications
- --talk-name=org.kde.StatusNotifierWatcher
- --talk-name=org.freedesktop.secrets
- --filesystem=xdg-documents
- --filesystem=xdg-run/gvfs #This might be needed
- --filesystem=xdg-run/pipewire-0:ro #This might be needed
- --own-name=org.mpris.MediaPlayer2.spotube
- --system-talk-name=org.freedesktop.NetworkManager
- --env=LD_LIBRARY_PATH=/app/lib # LNA: This is needed
modules:
- name: lmdb
  sources:
    - sha256: f3927859882eb608868c8c31586bb7eb84562a40a6bf5cc3e13b6b564641ea28
      type: archive
      url: https://github.com/LMDB/lmdb/archive/LMDB_0.9.22.tar.gz
  make-install-args:
    - prefix=/app
  no-autogen: true
  subdir: libraries/liblmdb

- name: parse-yapp
  buildsystem: simple
  build-commands:
    - perl Makefile.PL INSTALL_BASE=/app
    - make
    - make install
  sources:
    - type: archive
      url: https://cpan.metacpan.org/authors/id/W/WB/WBRASWELL/Parse-Yapp-1.21.tar.gz
      sha256: 3810e998308fba2e0f4f26043035032b027ce51ce5c8a52a8b8e340ca65f13e5

- name: smbclient
  config-opts:
    - --without-json
    - --without-ad-dc
    - --without-ldap
    - --without-ads
    - --without-pam
    - --disable-python
    - --disable-cups
    - --disable-iprint
    - --without-systemd
    - --bindir=.
    - --sbindir=.
    - --sysconfdir=.
  cleanup:
    - /lib/perl5
  build-options:
    env:
      PERL5LIB: /app/lib/perl5
  buildsystem: autotools
  sources:
    - type: archive
      archive-type: tar
      url: https://download.samba.org/pub/samba/stable/samba-4.21.3.tar.gz
      sha256: ae2179a613e7a5d4088735ab100d4ca1cae0f92374d6307e22eaec13ad90125c
      x-checker-data:
        type: html
        url: https://download.samba.org/pub/samba/stable/?C=M;O=D
        version-pattern: samba-(\d+\.\d+\.\d+).tar.gz
        url-template: https://download.samba.org/pub/samba/stable/samba-$version.tar.gz

- name: libass
  cleanup:
    - /include
    - /lib/pkgconfig
  config-opts:
    - --disable-static
    - --enable-asm
    - --enable-harfbuzz
    - --enable-fontconfig
  sources:
    - type: git
      url: https://github.com/libass/libass.git
      tag: 0.17.3
      commit: e46aedea0a0d17da4c4ef49d84b94a7994664ab5
      x-checker-data:
        type: git
        tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

- name: libgcrypt
  config-opts:
    - --disable-static
    - --disable-doc
  sources:
    - type: git
      url: https://dev.gnupg.org/source/libgcrypt.git
      tag: libgcrypt-1.10.3
      commit: aa1610866f8e42bdc272584f0a717f32ee050a22
      # disabled for libgcrypt-1.11 because of build fail
      #x-checker-data:
      #  type: anitya
      #  project-id: 1623
      #  stable-only: true
      #  tag-template: libgcrypt-$version

- name: libaacs
  config-opts:
    - --disable-static
    - --disable-bdjava-jar
  cleanup:
    - /include
    - /lib/pkgconfig
  sources:
    - sha256: a88aa0ebe4c98a77f7aeffd92ab3ef64ac548c6b822e8248a8b926725bea0a39
      type: archive
      url: https://download.videolan.org/pub/videolan/libaacs/0.11.1/libaacs-0.11.1.tar.bz2
      mirror-urls:
        - https://videolan.mirror.ba/libaacs/0.11.1/libaacs-0.11.1.tar.bz2
        - https://videolan.c3sl.ufpr.br/libaacs/0.11.1/libaacs-0.11.1.tar.bz2
      x-checker-data:
        type: html
        url: https://www.videolan.org/developers/libaacs.html
        version-pattern: Latest release is <b>libaacs (\d\.\d+\.?\d*)</b>
        url-template: https://download.videolan.org/pub/videolan/libaacs/$version/libaacs-$version.tar.bz2

- name: x264
  cleanup:
    - /include
    - /lib/pkgconfig
    - /share/man
  config-opts:
    - --disable-cli
    - --enable-shared
  sources:
    - type: git
      url: https://github.com/mirror/x264.git
      commit: 31e19f92f00c7003fa115047ce50978bc98c3a0d
      # Every commit to the stable branch is considered a release
      # https://code.videolan.org/videolan/x264/-/issues/35
      x-checker-data:
        type: json
        url: https://code.videolan.org/api/v4/projects/536/repository/branches/stable
        commit-query: .commit.id
        version-query: .commit.short_id
        timestamp-query: .commit.created_at

- name: x265
  buildsystem: cmake
  subdir: source
  config-opts:
    - -DCMAKE_BUILD_TYPE=Release
    - -DBUILD_STATIC=0
  cleanup:
    - /include
    - /lib/pkgconfig
    - /share/man
  sources:
    - type: git
      url: https://bitbucket.org/multicoreware/x265_git.git
      tag: '4.0'
      commit: 6318f223684118a2c71f67f3f4633a9e35046b00
      # build is failing with 4.1 will enable with 4.2
      #x-checker-data:
      #  type: git
      #  tag-pattern: ^([\d.]+)$

- name: libmysofa
  buildsystem: cmake
  config-opts:
    - -DBUILD_TESTS=OFF
  sources:
    - type: git
      commit: 444d2c1d7ececf5cc2d96d3b17b209047b02318d
      tag: v1.3.3
      url: https://github.com/hoene/libmysofa.git
      x-checker-data:
        type: git
        tag-pattern: ^v([\d.]+)$

- name: libbs2b
  buildsystem: autotools
  config-opts:
    - --disable-static
  cleanup:
    - /include
    - /lib/pkgconfig
  sources:
    - type: archive
      archive-type: tar
      url: https://downloads.sourceforge.net/sourceforge/bs2b/libbs2b-3.1.0.tar.gz
      sha256: 6aaafd81aae3898ee40148dd1349aab348db9bfae9767d0e66e0b07ddd4b2528
      x-checker-data:
        type: html
        url: https://sourceforge.net/projects/bs2b/files/libbs2b/
        version-pattern: projects/bs2b/files/libbs2b/(\d+\.\d+\.\d+)
        url-template: https://downloads.sourceforge.net/sourceforge/bs2b/libbs2b-$version.tar.gz
    # https://src.fedoraproject.org/rpms/libbs2b/blob/rawhide/f/libbs2b.spec#_40
    - type: shell
      commands:
        - sed -i -e 's/lzma/xz/g' configure.ac
        - autoreconf -vif

- name: ffmpeg
  cleanup:
    - /include
    - /lib/pkgconfig
    - /share/ffmpeg/examples
  config-opts:
    - --disable-debug
    - --disable-doc
    - --disable-static
    - --enable-encoder=png
    - --enable-gnutls
    - --enable-gpl
    - --enable-shared
    - --enable-version3
    - --enable-libaom
    - --enable-libass
    - --enable-libbs2b
    - --enable-libdav1d
    - --enable-libfreetype
    - --enable-libmp3lame
    - --enable-libopus
    - --enable-libjxl
    - --enable-libmysofa
    - --enable-libtheora
    - --enable-libv4l2
    - --enable-libvorbis
    - --enable-libvpx
    - --enable-libx264
    - --enable-libx265
    - --enable-libwebp
    - --enable-libsmbclient
    - --enable-libxml2
    - --enable-vulkan

  sources:
    - type: git
      url: https://github.com/FFmpeg/FFmpeg.git
      mirror-urls:
        - https://git.ffmpeg.org/ffmpeg.git
      commit: b08d7969c550a804a59511c7b83f2dd8cc0499b8
      tag: n7.1
      x-checker-data:
        type: git
        tag-pattern: ^n([\d.]{3,7})$

- name: libplacebo
  buildsystem: meson
  config-opts:
    - -Dvulkan=enabled
    - -Dshaderc=enabled
  cleanup:
    - /include
    - /lib/pkgconfig
  sources:
    - type: git
      url: https://github.com/haasn/libplacebo.git
      mirror-urls:
        - https://code.videolan.org/videolan/libplacebo.git
      tag: v7.349.0
      commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
      x-checker-data:
        type: git
        tag-pattern: ^v([\d.]+)$

- name: libmpv
  buildsystem: meson
  config-opts:
    - -Dlibmpv=true
    - -Dlua=disabled
    - -Ddebug=false
    - -Dbuild-date=false
    - -Dcplayer=false
    - -Dmanpage-build=disabled
    - -Dsdl2=enabled
    - -Dvulkan=enabled
  sources:
    - type: git
      url: https://github.com/mpv-player/mpv.git
      tag: v0.39.0
      commit: a0fba7be57f3822d967b04f0f6b6d6341e7516e7
      x-checker-data:
        type: git
        tag-pattern: ^v([\d.]+)$

- name: mpv-mpris
  no-autogen: true
  make-install-args:
    - SCRIPTS_DIR=/app/etc/mpv/scripts
  sources:
    - type: archive
      archive-type: tar
      url: https://api.github.com/repos/hoyon/mpv-mpris/tarball/1.1
      sha256: 08d6b53a41224710ebed1c4d6daee815686e0f2f10e3f81778f4411562ed5958
      x-checker-data:
        type: json
        url: https://api.github.com/repos/hoyon/mpv-mpris/releases/latest
        version-query: .name
        url-query: .tarball_url

# -----------------------------------------------------------------------------------

- name: open_media_server_app
  buildsystem: simple
  build-commands:
  - pwd
  - ls open_media_server_app -la

  - install -Dm644 open_media_server_app/org.openmediastation.open_media_server_app.appdata.xml /app/share/appdata/org.openmediastation.open_media_server_app.appdata.xml
  - install -Dm644 open_media_server_app/oms.desktop /app/share/applications/org.openmediastation.open_media_server_app.desktop
  - install -Dm644 open_media_server_app/AppIcon.png /app/share/icons/hicolor/512x512/apps/org.openmediastation.open_media_server_app.png

  - cp /app/lib/libmpv.so.2 /app/lib/libmpv.so.1

  - install -dm755 /app/bin /app/open_media_server_app
  - cp -R open_media_server_app/ /app
  - chmod +x /app/open_media_server_app/open_media_server_app
  - ln -s /app/open_media_server_app/open_media_server_app /app/bin/open_media_server_app
  sources:
  - type: archive
    path: linux-bin.zip
    dest: open_media_server_app
  - type: file
    path: org.openmediastation.open_media_server_app.appdata.xml
    dest: open_media_server_app
  - type: file
    path: oms.desktop
    dest: open_media_server_app
  - type: file
    path: AppIcon.png
    dest: open_media_server_app